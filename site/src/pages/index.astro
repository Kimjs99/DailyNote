---
import BaseLayout from "../layouts/BaseLayout.astro";
import Calendar from "../components/Calendar.astro";
import PostCard from "../components/PostCard.astro";
import {
  estimateReadingTime,
  formatDate,
  getBlogPosts,
  getPostDateKeys,
  groupByCategory,
  groupByMonth,
  groupByTag,
  slugify,
} from "../utils/content";

const posts = await getBlogPosts();
const featured = posts[0];
const recent = posts.slice(0, 3);
const categories = groupByCategory(posts);
const tags = groupByTag(posts);
const months = groupByMonth(posts);
const postDateKeys = getPostDateKeys(posts);
const baseUrl = import.meta.env.BASE_URL;

const now = new Date();
const displayYear = featured ? featured.data.pubDate.getFullYear() : now.getFullYear();
const displayMonth = featured ? featured.data.pubDate.getMonth() + 1 : now.getMonth() + 1;
---

<BaseLayout>
  <section class="hero">
    <div class="container">
      <div class="hero-grid">
        <div>
          <div class="hero-icon">
            <img
              src={`${import.meta.env.BASE_URL}blogicon.png`}
              alt="블로그 대표 아이콘"
            />
          </div>
          <p class="eyebrow">Minimal Editorial</p>
          <h1>천천히 써 내려가는 사려 깊은 하루.</h1>
          <p class="lede">
            공예와 루틴, 그리고 작은 선택들이 만드는 고요한 일상을 기록하는
            공간입니다.
          </p>
          <div class="hero-actions">
            <a class="button" href={`${baseUrl}blog/`}>아카이브 보기</a>
            {featured && (
              <a class="ghost" href={`${baseUrl}blog/${featured.slug}/`}>
                추천 글: {featured.data.title}
              </a>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container latest-layout">
      <div class="panel latest-panel">
        <h2 class="section-title">최신 글</h2>
        <div class="grid">
          {recent.map((post) => (
            <PostCard post={post} />
          ))}
        </div>
      </div>
      {featured && (
        <div class="panel hero-card featured-panel">
          <p class="eyebrow">추천 이야기</p>
          <h2>{featured.data.title}</h2>
          <p class="card-description">{featured.data.description}</p>
          <p class="card-meta">
            {formatDate(featured.data.pubDate)} ·{" "}
            {featured.data.readingTime ??
              estimateReadingTime(featured.body)}
          </p>
        </div>
      )}
    </div>
  </section>

  <section class="section">
    <div class="container panel grid two">
      <div>
        <h2 class="section-title">글 쓴 날</h2>
        <p class="lede calendar-lede">표시된 날을 누르면 그달 글로 이동합니다.</p>
        <Calendar
          postDateKeys={postDateKeys}
          year={displayYear}
          month={displayMonth}
          baseUrl={baseUrl}
        />
      </div>
      <div>
        <h2 class="section-title">월별 아카이브</h2>
        <div class="archive-list">
          {months.map((month) => (
            <a class="archive-item" href={`${baseUrl}blog/?month=${month.key}`}>
              <span>{month.label}</span>
              <span class="archive-count">{month.items.length}개</span>
            </a>
          ))}
        </div>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container grid two">
      <div class="panel">
        <h2 class="section-title">카테고리</h2>
        <div class="grid">
          {categories.map(([category, items]) => (
            <div>
              <p class="eyebrow">{items.length}개</p>
              <h3>
                <a href={`${baseUrl}categories/${slugify(category)}/`}>
                  {category}
                </a>
              </h3>
            </div>
          ))}
        </div>
      </div>
      <div class="panel">
        <h2 class="section-title">인기 태그</h2>
        <div class="tag-row">
          {tags.map(([tag]) => (
            <a class="tag" href={`${baseUrl}tags/${slugify(tag)}/`}>
              #{tag}
            </a>
          ))}
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .calendar-lede {
    margin-bottom: 0.6rem;
    font-size: 0.88rem;
  }

  .latest-layout {
    display: grid;
    gap: 2rem;
    grid-template-columns: minmax(0, 0.9fr) minmax(0, 1fr);
    align-items: start;
  }

  .latest-panel {
    max-width: 560px;
  }

  .featured-panel {
    margin-top: 1.5rem;
  }

  @media (max-width: 980px) {
    .latest-layout {
      grid-template-columns: 1fr;
    }

    .latest-panel {
      max-width: none;
    }

    .featured-panel {
      margin-top: 0;
    }
  }
</style>
