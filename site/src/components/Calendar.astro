---
interface Props {
  postDateKeys: Set<string>;
  year: number;
  month: number; // 1–12
  baseUrl: string;
}

const { postDateKeys, year, month, baseUrl } = Astro.props;

const WEEKDAYS = ["일", "월", "화", "수", "목", "금", "토"];
const first = new Date(year, month - 1, 1);
const last = new Date(year, month, 0);
const startBlank = first.getDay();
const totalDays = last.getDate();

function dateKey(y: number, m: number, d: number): string {
  return `${y}-${String(m).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
}

function monthKey(y: number, m: number): string {
  return `${y}-${String(m).padStart(2, "0")}`;
}

const monthLabel = new Intl.DateTimeFormat("ko-KR", {
  year: "numeric",
  month: "long",
}).format(first);

const days: { day: number; key: string; hasPost: boolean }[] = [];
for (let d = 1; d <= totalDays; d++) {
  const key = dateKey(year, month, d);
  days.push({ day: d, key, hasPost: postDateKeys.has(key) });
}
const hrefMonth = monthKey(year, month);
---

<div class="post-calendar">
  <p class="post-calendar-title">{monthLabel}</p>
  <div class="post-calendar-grid" role="grid" aria-label={`${monthLabel} 글 쓴 날`}>
    {WEEKDAYS.map((w) => (
      <span class="post-calendar-weekday" role="columnheader">{w}</span>
    ))}
    {Array.from({ length: startBlank }, () => (
      <span class="post-calendar-day post-calendar-day--blank" aria-hidden="true" />
    ))}
    {days.map(({ day, key, hasPost }) => (
      <span
        class:list={["post-calendar-day", { "post-calendar-day--has-post": hasPost }]}
        role="gridcell"
        aria-label={hasPost ? `${day}일 글 있음` : `${day}일`}
      >
        {hasPost ? (
          <a class="post-calendar-day-link" href={`${baseUrl}blog/?month=${hrefMonth}`}>
            {day}
          </a>
        ) : (
          <span>{day}</span>
        )}
      </span>
    ))}
  </div>
  <p class="post-calendar-legend">
    <span class="post-calendar-legend-dot post-calendar-legend-dot--has-post" /> 글을 쓴 날
  </p>
</div>

<style>
  .post-calendar {
    font-size: 0.8rem;
    max-width: 192px;
  }

  .post-calendar-title {
    font-family: "Manrope", system-ui, sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--ink);
    margin: 0 0 0.4rem;
    text-align: center;
  }

  .post-calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    max-width: 192px;
  }

  .post-calendar-weekday {
    text-align: center;
    font-size: 0.58rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--muted);
    padding: 0.2rem 0;
  }

  .post-calendar-day {
    min-height: 1.6rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    color: var(--muted);
    font-variant-numeric: tabular-nums;
    font-size: 0.75rem;
  }

  .post-calendar-day--blank {
    visibility: hidden;
    min-height: 1.6rem;
  }

  .post-calendar-day--has-post {
    background: rgba(192, 139, 90, 0.18);
    color: var(--accent-strong);
  }

  .post-calendar-day-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    min-height: 1.6rem;
    color: inherit;
    text-decoration: none;
    border-radius: inherit;
    transition: background 0.2s ease, color 0.2s ease;
  }

  .post-calendar-day-link:hover {
    background: var(--accent);
    color: #fff;
  }

  .post-calendar-legend {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.3rem;
    margin: 0.4rem 0 0;
    font-size: 0.65rem;
    color: var(--muted);
  }

  .post-calendar-legend-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
  }

  .post-calendar-legend-dot--has-post {
    background: var(--accent);
  }
</style>
